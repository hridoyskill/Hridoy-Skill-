<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(d,z,s){s.src='https://'+d+'/401/'+z;try{(document.body||document.documentElement).appendChild(s)}catch(e){}})('gizokraijaw.net',9583956,document.createElement('script'))</script>
    <meta name="monetag" content="601cf70bd190323d55053b88c81fd4c2">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hridoy Skill</title>
    <style>
        /* Global Variables for Colors (Dark/Light Mode) */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #000;
            --card-bg: #fff;
            --header-bg: linear-gradient(90deg, #007bff, #00c6ff);
            --button-bg: linear-gradient(45deg, #007bff, #00c6ff);
            --link-color: #007bff;
            --modal-bg: rgba(0, 0, 0, 0.7); /* Modal overlay background */
            --modal-content-bg: #fff;
        }
        /* Dark Mode Styles */
        body.dark {
            --bg-color: #121212;
            --text-color: #fff;
            --card-bg: #1e1e1e;
            --header-bg: linear-gradient(90deg, #333, #555);
            --button-bg: linear-gradient(45deg, #444, #777);
            --link-color: #00c6ff;
            --modal-content-bg: #2a2a2a;
        }
        /* Base Body Styles */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding-bottom: 80px; /* Space for fixed navigation bar */
            transition: background 0.3s, color 0.3s; /* Smooth transition for dark/light mode */
            -webkit-font-smoothing: antialiased; /* Better font rendering on mobile */
            -moz-osx-font-smoothing: grayscale;
        }
        /* Header Styles */
        header {
            background: var(--header-bg);
            color: white;
            padding: 15px; /* Slightly reduced padding for mobile */
            text-align: center;
            font-size: 18px; /* Slightly reduced font size for mobile */
            font-weight: bold;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Added subtle shadow for depth */
        }
        /* Dark Mode Toggle Button */
        .toggle-mode {
            position: absolute;
            top: 12px;
            right: 15px; /* Adjusted right spacing */
            font-size: 13px; /* Slightly smaller font */
            background: #fff3; /* Semi-transparent white */
            padding: 6px 10px; /* Adjusted padding */
            border-radius: 20px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        /* Main Container for Content */
        .container {
            max-width: 500px; /* Max width for larger screens */
            margin: auto; /* Center the container */
            padding: 15px; /* Reduced overall padding for mobile */
        }
        /* Section Visibility (for tab switching) */
        .section { display: none; }
        .section.active { display: block; } /* Show active section */
        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px; /* Slightly reduced margin between cards */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); /* Soft shadow for cards */
        }
        /* Button Styles */
        .btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background: var(--button-bg);
            border: none;
            border-radius: 30px; /* Rounded buttons */
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s ease; /* Smooth hover effect */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        .btn:hover { transform: scale(1.02); } /* Slight scale on hover */
        .btn:active { transform: scale(0.98); } /* Slight scale on active (tap) */
        /* Fixed Navigation Bar */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); /* Shadow above nav */
            display: none; /* Hidden by default, shown after login */
            z-index: 1000; /* Ensure nav is on top of other content */
        }
        /* NEW: Design for all nav buttons */
        nav button {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text-color);
            font-size: 15px;
            font-weight: 500;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        /* NEW: Design for the currently active/selected button */
        nav button.active {
            color: var(--link-color);
            font-weight: bold;
        }
        nav button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 3px;
            background: var(--link-color);
            border-radius: 2px;
        }
        /* Info/Status Messages */
        .info {
            font-weight: bold;
            color: green;
            margin-top: 10px;
            font-size: 14px; /* Slightly smaller font for info text */
            text-align: center; /* Center align info messages */
        }
        /* Input Field Styles */
        input[type="text"], input[type="file"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 15px; /* Slightly smaller font for inputs */
            box-sizing: border-box; /* Ensures padding doesn't increase width */
            background: var(--bg-color); /* Input background adapts to dark/light mode */
            color: var(--text-color); /* Input text color adapts to dark/light mode */
        }
        input[type="file"] {
            padding: 8px; /* Smaller padding for file input */
        }
        /* Username Display in Dashboard */
        #usernameDisplay {
            font-size: 18px;
            font-weight: bold;
            color: var(--link-color); /* Matches header/button gradient start color */
            margin-bottom: 15px;
            text-align: center;
            padding-top: 10px; /* Add some space above the text */
        }
        /* Small Screen Adjustments (Optional, but good practice for very small phones) */
        @media (max-width: 320px) {
            header {
                font-size: 16px;
                padding: 12px;
            }
            .toggle-mode {
                font-size: 12px;
                padding: 5px 8px;
            }
            .btn {
                font-size: 14px;
                padding: 12px;
            }
            nav button {
                font-size: 14px;
                padding: 10px;
            }
            .card {
                padding: 15px;
            }
        }
        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: var(--modal-bg); /* Black w/ opacity */
            justify-content: center; /* Center content horizontally */
            align-items: center; /* Center content vertically */
        }
        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 15% auto; /* 15% from the top and centered */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%; /* Responsive width */
            max-width: 400px; /* Max width for larger screens */
            text-align: center;
            position: relative; /* For close button positioning */
            color: var(--text-color);
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        #referralLinkInput {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            cursor: text; /* Allow selection */
        }
        .copy-btn {
            background: linear-gradient(45deg, #28a745, #218838); /* Green gradient for copy button */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: transform 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            margin-top: 10px;
        }
        .copy-btn:hover { transform: scale(1.02); }
        .copy-btn:active { transform: scale(0.98); }
        /* Flash message for copy confirmation */
        .flash-message {
            position: fixed;
            bottom: 90px; /* Above the nav bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745; /* Green for success */
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1002; /* Above modal */
            font-size: 14px;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .flash-message.show {
            opacity: 1;
        }
        /* Auth tab switcher */
        .auth-switcher {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: var(--bg-color);
            border-radius: 10px;
            padding: 5px;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        .auth-switcher button {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background: none;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
        }
        .auth-switcher button.active {
            background: var(--button-bg);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* New verification prompt styles */
        #verificationPrompt {
            text-align: center;
        }
        /* Referral history list styles */
        #referralHistoryList {
            list-style-type: none; /* Remove bullet points */
            padding: 0;
            margin-top: 10px;
        }
        #referralHistoryList li {
            background: #f8f9fa; /* Light grey background for list items */
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-size: 14px;
            color: #555;
        }
        body.dark #referralHistoryList li {
            background: #2a2a2a; /* Darker background for list items in dark mode */
            color: #ccc;
        }
    </style>
</head>
<body>
    <amp-auto-ads type="adsense"
        data-ad-client="ca-pub-7695343504541026">
    </amp-auto-ads>
    <header>
        Developer:Hridoy Skill
        <span class="toggle-mode" onclick="toggleDarkMode()">Mode</span>
    </header>
    <div class="container">
        <div id="auth" class="section active">
            <div class="auth-switcher">
                <button id="showRegisterBtn" onclick="showAuthTab('register')">Register</button>
                <button id="showLoginBtn" class="active" onclick="showAuthTab('login')">Login</button>
            </div>
            <div id="registerFormCard" class="card" style="display:none;">
                <h3>Register</h3>
                <p>Create your new account using your Telegram info and a password.</p>
                <input type="text" id="registerFullName" placeholder="Full Name" required>
                <input type="text" id="registerTelegramUserName" placeholder="Telegram Username (e.g., @your_username)" required>
                <input type="text" id="registerTelegramChatId" placeholder="Telegram Chat ID (e.g., 1234567890)" required>
                <input type="password" id="registerPassword" placeholder="Password (at least 8 characters)" required minlength="8">
                <button class="btn" onclick="handleRegister()">Register</button>
            </div>
            <div class="card" id="verificationPrompt" style="display:none;">
                <h3>Verify Code</h3>
                <p>Enter 6-digit code from Owners:</p>
                <input type="text" id="verifyCodeInput" placeholder="Enter Code" maxlength="6">
                <button class="btn" onclick="submitVerificationCode()">Verify & Complete</button>
            </div>
            <div id="loginFormCard" class="card">
                <h3>Login</h3>
                <p>Log in using your Telegram
                username and password.</p>
                <input type="text" id="loginTelegramUserName" placeholder="Telegram Username (e.g., @your_username)" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button class="btn" onclick="handleLogin()">Login</button>
                <button class="btn" onclick="showResetPasswordModal()">Reset Password</button>
                <button class="btn" onclick="showRolesFromLogin()" style="margin-top: 10px;">Roles & Rules</button>
            </div>
        </div>
        <div id="appSections" style="display: none;">
            <p id="usernameDisplay"></p>
            <div id="home" class="section">
                <div class="card">
                    <h3>Dashboard</h3>
                    <p>Balance: <strong id="balance">$0.000</strong></p>
                    <p>Total Ads Watched: <strong id="adsWatched">0</strong></p>
                    <p>Daily Ads Watched: <strong id="dailyAdsWatched">0</strong></p>
                    <p>Tasks Completed: <strong id="tasksCompleted">0</strong></p>
                    <p>Total Referrals: <strong id="totalReferrals">0</strong></p>
                    <hr style="margin-top: 20px; border: 0; border-top: 1px solid #eee;">
                    <h4>Your Referrals</h4>
                    <p style="font-size: 13px; color: #888;">Here's a list of users you've successfully referred.</p>
                    <ul id="referralHistoryList">
                        <li style="text-align: center;">No referrals yet.</li>
                    </ul>
                    <img src="https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1752401954/w0d4yapthokp30zvta1j.jpg" alt="Meditation Image" style="max-width:100%; height:auto; display:block; margin: 15px auto;">
                    <button class="btn" onclick="logout()">Logout</button>
                </div>
            </div>
            <div id="earn" class="section">
                <div class="card">
                    <h3>Watch Ads</h3>
                    <button class="btn" onclick="watchAd()">Watch Ad & Earn</button>
                    <p style="margin-top: 10px; font-weight: bold; text-align: center;">Daily Ads: <strong id="dailyAdsWatchedEarn">0</strong></p>
                    <p class="info" id="ad-status">Click the button to watch ad</p>
                    <p class="info" id="ad-target-message" style="color:orange;"></p>
                </div>
                <div class="card">
                    <h3>Tasks</h3>
                    <p style="margin-top: 10px; color: #888; text-align: center; font-size: 13px;">Complete a task, then submit a screenshot below for verification to earn!</p>
                    <button class="btn" onclick="taskWithRedirect('https://t.me/Hridoy_Skill')">Join Telegram</button>
                    <button class="btn" onclick="taskWithRedirect('https://youtube.com/@hridoy_skill_0.69?si=GfXezqZBlqsXYWVc')">Subscribe YouTube</button>
                    <button class="btn" onclick="taskWithRedirect('https://www.facebook.com/Hridoy.tudu.69')">Like Facebook Page</button>
                    <button class="btn" onclick="taskWithRedirect('https://instagram.com')">Follow Instagram</button>
                    <button class="btn" onclick="taskWithRedirect('https://youtu.be/Nqg8N0_RY_g?si=QFzA-UZbj6YxkIF9')">Share Post</button>
                    <button class="btn" onclick="showReferralLink()">Refer & Earn</button>
                    <hr style="margin-top:20px; border: 0; border-top: 1px solid #eee;">
                    <h4>Add Screenshots for Task Completion</h4>
                    <input type="text" id="screenshotUserNameInput" placeholder="Your Telegram Username or Chat ID (for verification)">
                    <input type="file" id="screenshotUpload" accept="image/*">
                    <button class="btn" onclick="submitScreenshot()">Submit Screenshot</button>
                    <p class="info" id="screenshot-status"></p>
                </div>
            </div>
            <div id="roles" class="section">
                <div class="card">
                    <h3>📜 Roles and Rules – Hridoy Skill Community 📜</h3>
                    <p>The registration fee is 200 BDT. To register, please contact the owner.
                    (Owner: @Hridoy_Tudu)
                    WhatsApp: 01402715862<p>
                    <p>
                        Here are the roles and rules for all members of the Hridoy Skill community. Please read carefully to ensure a positive and fair environment.
                    </p>
                    <h4> Important Points:</h4>
                    <ul>
                        <li>This is a part-time job. You can work whenever you want.</li>
                        <li>Do not add anyone to this bot by paying money or asking for money.</li>
                        <li>Do not cheat. Work correctly by following the rules.</li>
                        <li>Spreading rumors about the bot is strictly prohibited.</li>
                        <li>You cannot withdraw money whenever you want. You must follow the specified rules.</li>
                        <li>You cannot do tasks whenever you want. However, you can get work by referring as much as you want.</li>
                        <li>Joining the Hridoy Skill 0.69 channel is mandatory to receive all updates.</li>
                        <li>Before making a Withdraw Request, you must contact the Admin/Owner and wait patiently.</li>
                        <li>You can work with multiple accounts on one phone. However, you cannot open two or three accounts on one phone.</li>
                    </ul>
                    <h4> What you can do:</h4>
                    <ul>
                        <li>You can refer as you wish.</li>
                        <li>You can work whenever you want.</li>
                        <li>You can give positive reviews about the bot on various social accounts.</li>
                        <li>You can promote your social account with the permission of the Admin/Owner.</li>
                        <li>You can take a bot like mine if you wish.</li>
                    </ul>
                    <h4> Withdrawal Rules:</h4>
                    <ul>
                        <li>Minimum Withdrawal: 0.50 USD</li>
                        <li>Maximum Withdrawal: 2.00 USD</li>
                        <li>You must contact the Admin/Owner before making a withdrawal.</li>
                        <li>Withdrawal Date: Between the 5th and 6th of every month.</li>
                        <li>A charge of 5 taka will be deducted for each withdrawal.</li>
                        <li>Submitting the same task multiple times will result in a deduction.</li>
                        <li>If you repeatedly engage in scams, your payment will be canceled.</li>
                        <li>If you don't have a minimum of 5 referrals in your account, 15% of your money will be deducted.</li>
                    </ul>
                    <h4> How to work:</h4>
                    <ul>
                        <li>The work guidelines have been uploaded to YouTube.</li>
                        <li>Watch the entire video carefully and work according to the correct method.</li>
                        <li>If you work incorrectly, you will not receive payment.</li>
                    </ul>
                    <h4> Emergency Support:</h4>
                    <ul>
                        <li>WhatsApp: 01402715862</li>
                        <li>Call & Message: Available anytime</li>
                    </ul>
                    <p>Thank you all. If you follow the rules, everyone will benefit.</p>
                    <button class="btn" onclick="window.history.back()" style="margin-top: 20px;">Back</button>
                </div>
            </div>
            <div id="withdraw" class="section">
                <div class="card">
                    <h3>Withdraw</h3>
                    <p>Minimum: $0.50, Maximum: $2.00</p>
                    <input id="withdrawAmount" type="text" placeholder="Enter Amount">
                    <input id="withdrawMethod" type="text" placeholder="Payment Method or Account">
                    <button class="btn" onclick="submitWithdraw()">Submit Request</button>
                </div>
            </div>
            <div id="contact" class="section">
                <div class="card">
                    <h3>Contact</h3>
                    <button class="btn" onclick="window.open('https://t.me/szsadi11')">Chat with Admin</button>
                    <button class="btn" onclick="window.open('https://t.me/Hridoy_Tudu')">Contact Owner</button>
                    <button class="btn" onclick="window.open('https://youtu.be/Nqg8N0_RY_g?si=QFzA-UZbj6YxkIF9')">Watch Help Video</button>
                </div>
            </div>
            <div id="profile" class="section">
                <div class="card">
                    <h3>Profile</h3>
                    <p>Full Name: <strong id="profileFullName">N/A</strong></p>
                    <p>Telegram Username: <strong id="profileTelegramUserName">N/A</strong></p>
                    <p>Telegram Chat ID: <strong id="profileTelegramChatId">N/A</strong></p>
                    <p>Total Ads: <strong id="adsWatchedProfile">0</strong></p>
                    <p>Daily Ads: <strong id="dailyAdsWatchedProfile">0</strong></p>
                    <p>Total Tasks: <strong id="tasksCompletedProfile">0</strong></p>
                    <p>Total Withdraw: <strong id="withdrawTotal">$0.00</strong></p>
                    <p>Lifetime Referrals: <strong id="lifetimeReferralsProfile">0</strong></p>
                    <button class="btn" onclick="showTab('roles')" style="margin-top: 10px;">View Roles & Rules</button>
                    <p style="margin-top:10px;color:#888;">Developer:Hridoy Skill</p>
                    <img src="https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1752401954/w0d4yapthokp30zvta1j.jpg" alt="Meditation Image" style="max-width:100%; height:auto; display:block; margin: 15px auto;">
                </div>
            </div>
        </div>
    </div>
    <nav>
        <button onclick="showTab('home')">Home</button>
        <button onclick="showTab('earn')">Earn</button>
        <button onclick="showTab('withdraw')">Withdraw</button>
        <button onclick="showTab('contact')">Contact</button>
        <button onclick="showTab('profile')">Profile</button>
    </nav>
    <div id="referralModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeReferralModal()"></span>
            <h3>Your Referral Link</h3>
            <p style="font-size: 14px; color: #888;">Share this link to invite friends and earn!</p>
            <input type="text" id="referralLinkInput" value="" readonly>
            <button class="copy-btn" onclick="copyReferralLink()">Copy Link</button>
            <p id="copyStatus" style="font-size: 13px; color: green; margin-top: 10px;"></p>
        </div>
    </div>
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeResetPasswordModal()"></span>
            <h3>Reset Password</h3>
            <div id="resetUserNameStep">
                <p>Enter your registered Telegram Username to receive a verification code.</p>
                <input type="text" id="resetUserNameInput" placeholder="Your Telegram Username (e.g., @your_username)" required>
                <button class="btn" onclick="sendResetCode()">Send Code</button>
            </div>
            <div id="resetCodeStep" style="display:none;">
                <p>Enter the 6-digit code provided by the Owners.</p>
                <input type="text" id="resetCodeInput" placeholder="Verification Code" required maxlength="6">
                <button class="btn" onclick="verifyResetCode()">Verify Code</button>
            </div>
            <div id="resetNewPasswordStep" style="display:none;">
                <p>Enter your new password.</p>
                <input type="password" id="newPasswordInput" placeholder="New Password (at least 8 characters)" required minlength="8">
                <input type="password" id="confirmNewPasswordInput" placeholder="Confirm New Password" required>
                <button class="btn" onclick="setNewPassword()">Set New Password</button>
            </div>
            <p class="info" id="resetStatus" style="color:red;"></p>
        </div>
    </div>
    <div id="flashMessage" class="flash-message"></div>
    <script src="//libtl.com/sdk.js" data-zone="9572158" data-sdk="show_9572158"></script>
    <script>
        // --- Configuration Variables ---
        const TELEGRAM_BOT_TOKEN = '8116143152:AAGPvHsPWy7VQZuIJoO4_ZpVcwA_6kbRCjw';
        const TELEGRAM_CHAT_ID = '5965219037';
        const TELEGRAM_BOT_USERNAME = 'HridoySkill6725_bot';
        const MIN_WITHDRAW = 0.50;
        const MAX_WITHDRAW = 2.00;
        // --- Global State Variables ---
        // currentUserIdentifier will now store the Telegram User Name (without @)
        let currentUserIdentifier = null;
        // `users` is now an object where keys are Telegram User Names and values are user objects
        let users = JSON.parse(localStorage.getItem('users')) || {};
        let referrerChatId = null; // Stores the potential referrer's Telegram Chat ID obtained from URL
        let currentResetUserName = null; // Stores the Telegram User Name for the password reset process
        let generatedResetCode = null; // Stores the generated code for password reset
        // --- Utility Functions ---
        /**
         * Parses URL parameters.
         * @param {string} name - The name of the URL parameter to retrieve.
         * @returns {string} The value of the parameter, or an empty string if not found.
         */
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        /**
         * Saves the current user's data to the global 'users' object and then to localStorage.
         * This function should be called whenever user data (balance, stats, etc.) changes.
         */
        function saveUserData() {
            if (currentUserIdentifier && users[currentUserIdentifier]) {
                const userData = users[currentUserIdentifier];
                // Update the data in memory from the UI before saving
                userData.balance = parseFloat(document.getElementById('balance').innerText.replace('$', ''));
                userData.adsWatched = parseInt(document.getElementById('adsWatched').innerText);
                userData.dailyAdsWatched = parseInt(document.getElementById('dailyAdsWatched').innerText);
                userData.tasksCompleted = parseInt(document.getElementById('tasksCompleted').innerText);
                userData.totalWithdraw = parseFloat(document.getElementById('withdrawTotal').innerText.replace('$', ''));
                // NEW: totalReferrals and lifetimeReferrals are now separate
                userData.totalReferrals = parseInt(document.getElementById('totalReferrals').innerText);
                userData.lifetimeReferrals = parseInt(document.getElementById('lifetimeReferralsProfile').innerText);
            }
            localStorage.setItem('users', JSON.stringify(users));
        }
        /**
         * Loads a specific user's data from the 'users' object and updates the UI.
         * @param {string} userName - The Telegram User Name to load data for.
         */
        function loadUserData(userName) {
            if (users[userName]) {
                const userData = users[userName];
                
                // Ensure all properties exist, even for old users
                userData.totalReferrals = userData.totalReferrals || 0;
                userData.lifetimeReferrals = userData.lifetimeReferrals || 0;
                userData.referredUsers = userData.referredUsers || [];

                document.getElementById("balance").innerText = `$${userData.balance.toFixed(3)}`;
                document.getElementById("adsWatched").innerText = userData.adsWatched;
                document.getElementById("tasksCompleted").innerText = userData.tasksCompleted;
                document.getElementById("withdrawTotal").innerText = `$${userData.totalWithdraw.toFixed(3)}`;
                
                // Use separate values for home and profile
                document.getElementById("totalReferrals").innerText = userData.totalReferrals;
                document.getElementById("lifetimeReferralsProfile").innerText = userData.lifetimeReferrals;

                // Update profile section
                document.getElementById("profileFullName").innerText = userData.fullName || 'N/A';
                document.getElementById("profileTelegramUserName").innerText = `@${userData.telegramUserName}` || 'N/A';
                document.getElementById("profileTelegramChatId").innerText = userData.telegramChatId || 'N/A';
                
                // Handle daily ad reset
                const now = new Date().getTime();
                const lastReset = userData.lastAdResetDate ? new Date(userData.lastAdResetDate).getTime() : 0;
                const twentyFourHours = 24 * 60 * 60 * 1000;
                if (now - lastReset >= twentyFourHours) {
                    users[userName].dailyAdsWatched = 0;
                    users[userName].lastAdResetDate = new Date().toISOString();
                }
                document.getElementById("dailyAdsWatched").innerText = users[userName].dailyAdsWatched;
                document.getElementById("dailyAdsWatchedEarn").innerText = users[userName].dailyAdsWatched;
            } else {
                document.getElementById("balance").innerText = `$0.000`;
                document.getElementById("adsWatched").innerText = 0;
                document.getElementById("dailyAdsWatched").innerText = 0;
                document.getElementById("dailyAdsWatchedEarn").innerText = 0;
                document.getElementById("tasksCompleted").innerText = 0;
                document.getElementById("withdrawTotal").innerText = `$0.000`;
                document.getElementById("totalReferrals").innerText = 0;
                document.getElementById("lifetimeReferralsProfile").innerText = 0;
                document.getElementById("profileFullName").innerText = 'N/A';
                document.getElementById("profileTelegramUserName").innerText = 'N/A';
                document.getElementById("profileTelegramChatId").innerText = 'N/A';
            }
            updateProfileStats();
            updateReferralHistoryDisplay();
        }
        /**
         * Sends a message to the Telegram bot.
         * @param {string} message - The text message to send.
         */
        async function sendTelegramMessage(message) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
                });
                const result = await response.json();
                if (!result.ok) {
                    console.error("Failed to send Telegram message:", result.description);
                }
            } catch (error) {
                console.error("Error sending Telegram message:", error);
            }
        }
        /**
         * Displays a flash message at the bottom of the screen.
         * @param {string} message - The message to display.
         * @param {number} [duration=3000] - The duration in milliseconds for the message to be visible.
         */
        function showFlashMessage(message, duration = 3000) {
            const flashMessageDiv = document.getElementById('flashMessage');
            flashMessageDiv.innerText = message;
            flashMessageDiv.classList.add('show');
            setTimeout(() => {
                flashMessageDiv.classList.remove('show');
            }, duration);
        }
        /**
         * Toggles dark mode on and off.
         */
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
        }
        /**
         * Generates a random 6-digit code.
         * @returns {string} The 6-digit code.
         */
        function generateCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        // --- Authentication Functions ---
        /**
         * Handles user registration using Telegram Username, Chat ID, and Password.
         */
        async function handleRegister() {
            const fullName = document.getElementById('registerFullName').value.trim();
            const telegramUserName = document.getElementById('registerTelegramUserName').value.trim().toLowerCase().replace('@', ''); // Remove @ if present
            const telegramChatId = document.getElementById('registerTelegramChatId').value.trim();
            const password = document.getElementById('registerPassword').value;
            if (!fullName || !telegramUserName || !telegramChatId || !password) {
                showFlashMessage("Please fill in all fields for registration.");
                return;
            }
            if (isNaN(telegramChatId) || telegramChatId.length < 5) { // Basic validation for chat ID
                showFlashMessage("Please enter a valid Telegram Chat ID (numeric).");
                return;
            }
            if (password.length < 8) {
                showFlashMessage("Password must be at least 8 characters long.");
                return;
            }
            // Check if Telegram Username or Chat ID already exists
            for (const userNameKey in users) {
                if (users[userNameKey].telegramUserName === telegramUserName) {
                    showFlashMessage("This Telegram Username is already registered. Please log in or use a different username.");
                    return;
                }
                if (users[userNameKey].telegramChatId === telegramChatId) {
                    showFlashMessage("This Telegram Chat ID is already registered. Please log in or use a different Chat ID.");
                    return;
                }
            }
            const verificationCode = generateCode();
            // Register new user, using telegramUserName as the primary key
            users[telegramUserName] = {
                fullName: fullName,
                telegramUserName: telegramUserName,
                telegramChatId: telegramChatId,
                password: password, // For simplicity. In production, hash passwords!
                verified: false,
                verificationCode: verificationCode,
                balance: 0.000,
                adsWatched: 0,
                dailyAdsWatched: 0,
                lastAdResetDate: new Date().toISOString(),
                tasksCompleted: 0,
                totalWithdraw: 0.000,
                totalReferrals: 0,
                lifetimeReferrals: 0, // NEW: Add lifetime referrals
                referredUsers: []
            };
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('pendingUser', telegramUserName);
            // Send registration notification to Telegram
            const registrationMessage = `New Registration!\n\nFull Name: ${fullName}\nTelegram Username: @${telegramUserName}\nTelegram Chat ID: ${telegramChatId}\nVerification Code: ${verificationCode}`;
            await sendTelegramMessage(registrationMessage);
            showFlashMessage("Code sent to admin. Get it and verify.");
            document.getElementById('registerFormCard').style.display = 'none';
            document.getElementById('verificationPrompt').style.display = 'block';
        }
        /**
         * Handles the verification code submission.
         */
        function submitVerificationCode() {
            const code = document.getElementById('verifyCodeInput').value.trim();
            const userKey = localStorage.getItem('pendingUser');
            const resetStatus = document.getElementById('resetStatus');
            if (users[userKey] && users[userKey].verificationCode === code) {
                users[userKey].verified = true;
                delete users[userKey].verificationCode;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.removeItem('pendingUser');
                // If there's a referrer (by Telegram Chat ID)
                let referralMessagePart = "";
                const referrerChatIdFromSession = sessionStorage.getItem('tempReferrerChatId');
                if (referrerChatIdFromSession) {
                    let referrerFound = false;
                    for (const userNameKey in users) {
                        if (users[userNameKey].telegramChatId === referrerChatIdFromSession && userKey !== userNameKey) { // Ensure user doesn't refer themselves
                            // Initialize new properties if they don't exist
                            users[userNameKey].totalReferrals = users[userNameKey].totalReferrals || 0;
                            users[userNameKey].lifetimeReferrals = users[userNameKey].lifetimeReferrals || 0;
                            users[userNameKey].referredUsers = users[userNameKey].referredUsers || [];

                            users[userKey].referredBy = users[userNameKey].telegramUserName;
                            users[userNameKey].balance += 0.020;
                            users[userNameKey].totalReferrals++;
                            users[userNameKey].lifetimeReferrals++;
                            users[userNameKey].referredUsers.push(userKey);
                            referralMessagePart = `\nReferred by: ${users[userNameKey].fullName} (Chat ID: ${referrerChatIdFromSession})\nReferral bonus paid to referrer.`;
                            referrerFound = true;
                            break;
                        }
                    }
                    if (!referrerFound) {
                        referralMessagePart = `\nReferrer Chat ID (${referrerChatIdFromSession}) not found or invalid.`;
                    }
                } else {
                    referralMessagePart = `\nNo referrer.`;
                }
                saveUserData();
                showFlashMessage("Verification complete. Please login.");
                document.getElementById('verificationPrompt').style.display = 'none';
                document.getElementById('loginFormCard').style.display = 'block';
                showAuthTab('login');
            } else {
                showFlashMessage("Invalid code. Try again.");
            }
        }
        /**
         * Handles user login using Telegram Username and Password.
         */
        function handleLogin() {
            const loginTelegramUserName = document.getElementById('loginTelegramUserName').value.trim().toLowerCase().replace('@', '');
            const loginPassword = document.getElementById('loginPassword').value;
            // Check if the provided username exists as a key in our users object
            if (users[loginTelegramUserName]) {
                const userData = users[loginTelegramUserName];
                if (!userData.verified) {
                    showFlashMessage("Please verify your account first.");
                    return;
                }
                // Verify the password
                if (userData.password === loginPassword) {
                    currentUserIdentifier = loginTelegramUserName;
                    localStorage.setItem('loggedInUser', currentUserIdentifier);
                    loadUserData(currentUserIdentifier);
                    const now = new Date();
                    const lastLoginDate = new Date(userData.lastLoginDate);
                    if (now.getDate() !== lastLoginDate.getDate() || now.getMonth() !== lastLoginDate.getMonth() || now.getFullYear() !== lastLoginDate.getFullYear()) {
                        userData.dailyAdsWatched = 0;
                    }
                    userData.lastLoginDate = now;
                    document.getElementById('usernameDisplay').innerText = `Welcome, ${userData.fullName}! (@${userData.telegramUserName})`;
                    document.getElementById('auth').style.display = 'none';
                    document.getElementById('appSections').style.display = 'block';
                    document.querySelector('nav').style.display = 'flex';
                    showTab('home');
                    showFlashMessage("Login successful!");
                    document.getElementById('loginTelegramUserName').value = '';
                    document.getElementById('loginPassword').value = '';
                } else {
                    showFlashMessage("Invalid password. Please try again.");
                }
            } else {
                showFlashMessage("Telegram Username not found. Please register if you don't have an account.");
            }
        }
        /**
         * Logs out the current user, saves their data, and returns to the authentication screen.
         */
        function logout() {
            if (confirm("Are you sure you want to log out?")) {
                saveUserData();
                currentUserIdentifier = null;
                localStorage.removeItem('loggedInUser');
                document.getElementById('auth').style.display = 'block';
                document.getElementById('appSections').style.display = 'none';
                document.querySelector('nav').style.display = 'none';
                showAuthTab('login');
                showFlashMessage("You have been logged out successfully.");
            }
        }
        /**
         * Checks if a user was previously logged in on page load and restores the session.
         */
        function checkLoginStatus() {
            // Check for referrer Telegram Chat ID in URL
            const refParam = getUrlParameter('startapp');
            if (refParam && refParam.startsWith('ref_')) {
                referrerChatId = decodeURIComponent(refParam.substring(4)); // Chat ID is numeric, no .toLowerCase().replace('@', '')
                if (!isNaN(referrerChatId) && referrerChatId.length >= 5) { // Basic validation
                     console.log(`Potential referrer Telegram Chat ID found in URL: ${referrerChatId}`);
                     sessionStorage.setItem('tempReferrerChatId', referrerChatId);
                } else {
                    referrerChatId = null; // Invalid Chat ID
                }
            } else {
                referrerChatId = sessionStorage.getItem('tempReferrerChatId');
            }
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser && users[loggedInUser]) {
                currentUserIdentifier = loggedInUser;
                loadUserData(currentUserIdentifier);
                const userData = users[currentUserIdentifier];
                document.getElementById('usernameDisplay').innerText = `Welcome, ${userData.fullName}! (@${userData.telegramUserName})`;
                document.getElementById('auth').style.display = 'none';
                document.getElementById('appSections').style.display = 'block';
                document.querySelector('nav').style.display = 'flex';
                showTab('home');
            } else {
                document.getElementById('auth').style.display = 'block';
                document.getElementById('appSections').style.display = 'none';
                document.querySelector('nav').style.display = 'none';
                showAuthTab('login');
            }
        }
        /**
         * Toggles between Register and Login forms.
         * @param {string} tabId - 'register' or 'login'.
         */
        function showAuthTab(tabId) {
            document.getElementById('registerFormCard').style.display = 'none';
            document.getElementById('loginFormCard').style.display = 'none';
            document.getElementById('verificationPrompt').style.display = 'none';
            document.getElementById('showRegisterBtn').classList.remove('active');
            document.getElementById('showLoginBtn').classList.remove('active');
            if (tabId === 'register') {
                document.getElementById('registerFormCard').style.display = 'block';
                document.getElementById('showRegisterBtn').classList.add('active');
            } else {
                document.getElementById('loginFormCard').style.display = 'block';
                document.getElementById('showLoginBtn').classList.add('active');
            }
        }
        /**
         * Shows the Roles & Rules section from the login page.
         */
        function showRolesFromLogin() {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('appSections').style.display = 'block';
            document.querySelector('nav').style.display = 'none';
            showTab('roles');
        }
        /**
         * Shows the selected main application tab and hides others.
         * @param {string} tabId - The ID of the tab to show (e.g., 'home', 'earn').
         */
        function showTab(tabId) {
            // Hide all sections
            document.querySelectorAll('#appSections .section').forEach(s => s.classList.remove('active'));
            // Deactivate all nav buttons
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            if (document.getElementById('appSections').style.display === 'block') {
                // Show the selected section
                document.getElementById(tabId).classList.add('active');
                // Activate the corresponding nav button
                const navButton = document.querySelector(`nav button[onclick*="showTab('${tabId}')"]`);
                if (navButton) {
                    navButton.classList.add('active');
                }
            }
            updateProfileStats();
            updateReferralHistoryDisplay();
        }
        /**
         * Updates the balance, ads watched, tasks completed, and referrals displays for the current user.
         */
        function updateStatsDisplay() {
            const userData = users[currentUserIdentifier];
            if (!userData) return;
            document.getElementById("balance").innerText = `$${userData.balance.toFixed(3)}`;
            document.getElementById("adsWatched").innerText = userData.adsWatched;
            document.getElementById("dailyAdsWatched").innerText = userData.dailyAdsWatched;
            document.getElementById("dailyAdsWatchedEarn").innerText = userData.dailyAdsWatched;
            document.getElementById("tasksCompleted").innerText = userData.tasksCompleted;
            
            // NEW: Use separate values for home and profile
            document.getElementById("totalReferrals").innerText = userData.totalReferrals;
            document.getElementById("lifetimeReferralsProfile").innerText = userData.lifetimeReferrals;
            
            updateProfileStats();
            updateReferralHistoryDisplay(); // Update the referral history list
        }
        /**
         * Updates the profile tab's specific statistics.
         */
        function updateProfileStats() {
            const userData = users[currentUserIdentifier];
            if (!userData) return;
            document.getElementById("profileFullName").innerText = userData.fullName || 'N/A';
            document.getElementById("profileTelegramUserName").innerText = `@${userData.telegramUserName}` || 'N/A';
            document.getElementById("profileTelegramChatId").innerText = userData.telegramChatId || 'N/A';
            document.getElementById("adsWatchedProfile").innerText = userData.adsWatched;
            document.getElementById("dailyAdsWatchedProfile").innerText = userData.dailyAdsWatched;
            document.getElementById("tasksCompletedProfile").innerText = userData.tasksCompleted;
            document.getElementById("withdrawTotal").innerText = `$${userData.totalWithdraw.toFixed(3)}`;
            // NEW: Profile now shows lifetime referrals
            document.getElementById("lifetimeReferralsProfile").innerText = userData.lifetimeReferrals;
            const adTargetMessage = document.getElementById("ad-target-message");
            if (userData.dailyAdsWatched < 100) {
                adTargetMessage.innerText = `You can watch ${100 - userData.dailyAdsWatched} more ads today.`;
            } else {
                adTargetMessage.innerText = `You have watched ${userData.dailyAdsWatched} ads for today.`;
            }
        }
        /**
         * NEW: Populates the referral history list on the dashboard.
         */
        function updateReferralHistoryDisplay() {
            const referralHistoryList = document.getElementById('referralHistoryList');
            const userData = users[currentUserIdentifier];
            if (!userData || !userData.referredUsers || userData.referredUsers.length === 0) {
                referralHistoryList.innerHTML = '<li style="text-align: center;">No referrals yet.</li>';
                return;
            }
            referralHistoryList.innerHTML = '';
            userData.referredUsers.forEach(referredUserKey => {
                const referredUser = users[referredUserKey];
                if (referredUser) {
                    const listItem = document.createElement('li');
                    listItem.innerText = `Referred: @${referredUser.telegramUserName} (${referredUser.fullName})`;
                    referralHistoryList.appendChild(listItem);
                }
            });
        }
        // --- Core Application Features ---
        /**
         * Simulates watching an ad and awards balance.
         * Integrates with an external ad SDK.
         */
        function watchAd() {
            if (!currentUserIdentifier) { showFlashMessage("Please log in to watch ads."); return; }
            const status = document.getElementById("ad-status");
            const adTargetMessage = document.getElementById("ad-target-message");
            if (typeof show_9572158 === "function") {
                show_9572158();
            } else {
                showFlashMessage("Ads not loaded. Please ensure you have an active internet connection or try refreshing the page.");
                return;
            }
            if (users[currentUserIdentifier].dailyAdsWatched >= 100) {
                status.innerText = "Your daily ad limit is reached. Please try again tomorrow.";
                adTargetMessage.innerText = `You have watched ${users[currentUserIdentifier].dailyAdsWatched} ads for today.`;
                return;
            }
            let sec = 15;
            status.innerText = `Please watch... ${sec}s`;
            let timer = setInterval(() => {
                sec--;
                if (sec > 0) {
                    status.innerText = `Please watch... ${sec}s`;
                } else {
                    clearInterval(timer);
                    users[currentUserIdentifier].balance += 0.005;
                    users[currentUserIdentifier].adsWatched++;
                    users[currentUserIdentifier].dailyAdsWatched++;
                    users[currentUserIdentifier].lastAdResetDate = new Date().toISOString();
                    updateStatsDisplay();
                    status.innerText = `Earned $0.005!`;
                    saveUserData();
                    if (users[currentUserIdentifier].dailyAdsWatched < 100) {
                        adTargetMessage.innerText = `You can watch ${100 - users[currentUserIdentifier].dailyAdsWatched} more ads today.`
                    }
                }
            }, 1000);
        }
        /**
         * Handles task completion with a redirect.
         * @param {string} url - The URL to redirect the user to for the task.
         */
        function taskWithRedirect(url) {
            if (!currentUserIdentifier) { showFlashMessage("Please log in to complete tasks."); return; }
            if (url.startsWith('http://googleusercontent.com/youtube.com/')) {
                const videoId = url.split('/').pop();
                console.log(`Attempting to open YouTube video with ID: ${videoId}`);
            }
            window.open(url, '_blank');
            showFlashMessage("Task opened. Please complete the task and submit a screenshot for verification to earn!");
        }
        /**
         * Displays the referral modal with the user's unique Telegram Chat ID referral link
         * directly to the Telegram bot with the 'startapp' parameter.
         */
        function showReferralLink() {
            if (currentUserIdentifier && users[currentUserIdentifier] && users[currentUserIdentifier].telegramChatId) {
                const botUsername = TELEGRAM_BOT_USERNAME;
                const referrerTelegramChatId = users[currentUserIdentifier].telegramChatId;
                const referralLink = `https://t.me/${botUsername}?startapp=ref_${encodeURIComponent(referrerTelegramChatId)}`;
                document.getElementById('referralLinkInput').value = referralLink;
                document.getElementById('referralModal').style.display = 'flex';
                document.getElementById('copyStatus').innerText = '';
            } else {
                showFlashMessage("Please log in and ensure your Telegram Chat ID is set to generate a referral link.");
            }
        }
        /**
         * Hides the referral modal.
         */
        function closeReferralModal() {
            document.getElementById('referralModal').style.display = 'none';
        }
        /**
         * Copies the referral link from the input field to the clipboard.
         */
        function copyReferralLink() {
            const referralLinkInput = document.getElementById('referralLinkInput');
            referralLinkInput.select();
            referralLinkInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(referralLinkInput.value).then(() => {
                document.getElementById('copyStatus').innerText = "Link copied successfully!";
                showFlashMessage("Referral link copied!");
                setTimeout(() => {
                    document.getElementById('copyStatus').innerText = '';
                    closeReferralModal();
                }, 1500);
            }).catch(err => {
                document.getElementById('copyStatus').innerText = "Failed to copy. Copy manually.";
                showFlashMessage("Failed to copy link!");
                console.error('Failed to copy referral link: ', err);
            });
        }
        /**
         * Handles submitting a screenshot for task verification to Telegram.
         */
        async function submitScreenshot() {
            if (!currentUserIdentifier) { showFlashMessage("Please log in to submit screenshots."); return; }
            const userNameForScreenshot = document.getElementById("screenshotUserNameInput").value.trim().toLowerCase().replace('@', '');
            const screenshotFile = document.getElementById("screenshotUpload").files;
            const screenshotStatus = document.getElementById("screenshot-status");
            if (!userNameForScreenshot || screenshotFile.length === 0) {
                showFlashMessage("Please enter your Telegram Username or Chat ID for verification and select a screenshot image.");
                return;
            }
            const currentUserData = users[currentUserIdentifier];
            let isMatch = false;
            // Allow either Telegram User Name or Chat ID for verification
            if (userNameForScreenshot === currentUserData.telegramUserName || userNameForScreenshot === currentUserData.telegramChatId) {
                isMatch = true;
            }
            if (!isMatch) {
                showFlashMessage("The Telegram Username or Chat ID entered for screenshot verification must match your logged-in account.");
                return;
            }
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID); // Send to admin's chat ID
            formData.append('caption', `New task screenshot submitted:\nUser: ${currentUserData.fullName} (@${currentUserData.telegramUserName})\nChat ID: ${currentUserData.telegramChatId}\nSubmitted ID on screenshot: ${userNameForScreenshot}`);
            formData.append('photo', screenshotFile[0]);
            screenshotStatus.innerText = "Sending screenshot...";
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.ok) {
                    screenshotStatus.innerText = "Screenshot sent successfully! Waiting for verification...";
                    showFlashMessage("Screenshot sent!");
                    let sec = 10; // 10 second delay for "verification"
                    let timer = setInterval(() => {
                        sec--;
                        if (sec > 0) {
                            screenshotStatus.innerText = `Verifying... ${sec}s`;
                        } else {
                            clearInterval(timer);
                            users[currentUserIdentifier].balance += 0.005;
                            users[currentUserIdentifier].tasksCompleted++;
                            updateStatsDisplay();
                            screenshotStatus.innerText = `Verification complete! $0.005 added to your balance.`;
                            showFlashMessage(`Verification complete! $0.005 added to your balance.`);
                            document.getElementById("screenshotUserNameInput").value = '';
                            document.getElementById("screenshotUpload").value = '';
                            saveUserData();
                        }
                    }, 1000);
                } else {
                    screenshotStatus.innerText = "Failed to send screenshot. Please try again. Error: " + (result.description || "Unknown");
                    showFlashMessage("Failed to send screenshot!");
                    console.error("Telegram API error:", result);
                }
            } catch (error) {
                console.error("Error submitting screenshot:", error);
                screenshotStatus.innerText = "An error occurred while submitting the screenshot. Please check your internet connection.";
                showFlashMessage("Network error!");
            }
        }
        /**
         * Handles user withdrawal requests, sends details to Telegram, and updates balance.
         */
        async function submitWithdraw() {
            if (!currentUserIdentifier) { showFlashMessage("Please log in to withdraw funds."); return; }
            const amount = parseFloat(document.getElementById("withdrawAmount").value);
            const method = document.getElementById("withdrawMethod").value;
            const userData = users[currentUserIdentifier];
            if (!amount || !method) {
                showFlashMessage("Please fill all fields correctly.");
                return;
            }
            if (amount <= 0) {
                showFlashMessage("Withdrawal amount must be greater than zero.");
                return;
            }
            if (amount < MIN_WITHDRAW) {
                showFlashMessage(`Minimum withdrawal amount is $${MIN_WITHDRAW.toFixed(2)}.`);
                return;
            }
            if (amount > MAX_WITHDRAW) {
                showFlashMessage(`Maximum withdrawal amount is $${MAX_WITHDRAW.toFixed(2)}.`);
                return;
            }
            if (amount > userData.balance) {
                showFlashMessage("Insufficient balance. You cannot withdraw more than your current balance.");
                return;
            }
            const message = `New Withdraw Request from user: ${userData.fullName} (@${currentUserIdentifier})\nChat ID: ${userData.telegramChatId}\nAmount: $${amount.toFixed(3)}\nPayment Method: ${method}\nBalance Before: $${userData.balance.toFixed(3)}\nTotal Referrals Before: ${userData.totalReferrals}`;
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
                });
                const result = await response.json();
                if (result.ok) {
                    userData.balance -= amount;
                    userData.totalWithdraw += amount;
                    // UPDATED: Now resets the home referral count but not the lifetime count
                    userData.totalReferrals = 0;
                    updateStatsDisplay();
                    showFlashMessage("Withdraw request sent successfully! Your balance has been updated.");
                    document.getElementById("withdrawAmount").value = '';
                    document.getElementById("withdrawMethod").value = '';
                    saveUserData();
                } else {
                    showFlashMessage("Failed to send withdraw request. Please try again.");
                    console.error("Telegram API error:", result);
                }
            } catch (error) {
                console.error("Error submitting withdraw request:", error);
                showFlashMessage("An error occurred while submitting the withdraw request.");
            }
        }
        // --- Password Reset Logic ---
        function showResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'flex';
            document.getElementById('resetUserNameStep').style.display = 'block';
            document.getElementById('resetCodeStep').style.display = 'none';
            document.getElementById('resetNewPasswordStep').style.display = 'none';
            document.getElementById('resetStatus').innerText = '';
            document.getElementById('resetUserNameInput').value = '';
            document.getElementById('resetCodeInput').value = '';
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('confirmNewPasswordInput').value = '';
            currentResetUserName = null;
            generatedResetCode = null;
        }
        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }
        async function sendResetCode() {
            const userName = document.getElementById('resetUserNameInput').value.trim().toLowerCase().replace('@', '');
            const resetStatus = document.getElementById('resetStatus');
            if (!userName) {
                resetStatus.innerText = "Please enter your Telegram Username.";
                return;
            }
            if (!users[userName]) {
                resetStatus.innerText = "This Telegram Username is not registered.";
                return;
            }
            currentResetUserName = userName;
            generatedResetCode = generateCode(); // Generate your 6-digit code
            const userToReset = users[userName];
            const message = `Password Reset Code Request:\n\nUser Telegram Username: @${userToReset.telegramUserName}\nUser Telegram Chat ID: ${userToReset.telegramChatId}\n\nVerification Code: ${generatedResetCode}\n\nPlease provide this code to the user to reset their password.`;
            resetStatus.innerText = "Sending code to admin's Telegram...";
            try {
                // Send to admin's Telegram Chat ID
                await sendTelegramMessage(message);
                resetStatus.innerText = `Code sent to admin's Telegram. Please contact the admin (@${userToReset.telegramUserName} or ${userToReset.telegramChatId}) and get the code to proceed.`;
                showFlashMessage("Verification code sent to admin's Telegram. Please contact admin.");
                setTimeout(() => {
                    document.getElementById('resetUserNameStep').style.display = 'none';
                    document.getElementById('resetCodeStep').style.display = 'block';
                    document.getElementById('resetStatus').innerText = `Code sent. Please get the code from admin (@${userToReset.telegramUserName} or ${userToReset.telegramChatId}).`;
                }, 2000); // Simulate network delay
            } catch (error) {
                console.error("Error sending code to Telegram (Admin):", error);
                resetStatus.innerText = "Failed to send code to admin's Telegram. Please try again.";
                showFlashMessage("Failed to send code!");
            }
        }
        function verifyResetCode() {
            const enteredCode = document.getElementById('resetCodeInput').value.trim();
            const resetStatus = document.getElementById('resetStatus');
            if (enteredCode === generatedResetCode) {
                document.getElementById('resetCodeStep').style.display = 'none';
                document.getElementById('resetNewPasswordStep').style.display = 'block';
                resetStatus.innerText = "";
                showFlashMessage("Code verified. Please set your new password.");
            } else {
                resetStatus.innerText = "Invalid code. Please try again.";
            }
        }
        function setNewPassword() {
            const newPassword = document.getElementById('newPasswordInput').value;
            const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value;
            const resetStatus = document.getElementById('resetStatus');
            if (!newPassword || newPassword.length < 8) {
                resetStatus.innerText = "Password must be at least 8 characters long.";
                return;
            }
            if (newPassword !== confirmNewPassword) {
                resetStatus.innerText = "Passwords do not match.";
                return;
            }
            if (currentResetUserName && users[currentResetUserName]) {
                users[currentResetUserName].password = newPassword;
                saveUserData();
                showFlashMessage("Password successfully reset! You can now log in with your new password.");
                closeResetPasswordModal();
                showAuthTab('login');
                document.getElementById('loginTelegramUserName').value = currentResetUserName;
                document.getElementById('loginPassword').value = '';
                currentResetUserName = null;
                generatedResetCode = null;
            } else {
                resetStatus.innerText = "An error occurred. Please restart the password reset process.";
            }
        }
        // --- Initialize App ---
        window.onload = checkLoginStatus;
    </script>
</body>
</html>